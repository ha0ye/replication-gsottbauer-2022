---
title: "Supplementary-Survey1"
output: github_document
---

# Setup

First, load up the necessary packages. We are operating in interactive mode, so `{{tidyverse}}` can be used and is inclusive of `{{ggplot2}}`, `{{scales}}`, and `{{dplyr}}`.

```{r load packages}
library(readstata13)
library(psych)
library(tidyverse)
library(scales)
library(gt)
library(pander)
```

We don't need to set paths, and assume folks will follow the practice of using an RStudio project with the project folder as the main parent folder. All paths are thus local to that.

```{r set data paths}
datafile_survey_1 <- here::here("data", "MasterFile_Survey1.dta")
```

# Survey 1 (German Internet Panel)

## Read in data

```{r load data}
# load data - labels will be lost
df_study1 <- read.dta13(file = datafile_survey_1, 
                        convert.factors = TRUE, 
                        nonint.factors = TRUE)
```

## Recoding

```{r}
dat_study1 <- df_study1 %>%
    rename(priming = rich) %>%
    mutate(priming = case_match(priming, 
                                0 ~ "primed poor", 
                                1 ~ "primed rich"), 
           income = income * 1000, 
           male = male * 100, 
           married = married * 100, 
           student = student * 100, 
           east = east * 100)
```

## Generate Table 1 (sample summary statistics - survey 1)
```{r, results = "asis"}
summary_vars <- c("income", "male", "age", "edu", "married", 
                  "student", "religiousness", "east", "leftright")

# define function to count number of not NA values
obs <- function(x, na.rm) {sum(is.finite(x))}

# define function to create summary table
make_summary_table <- function(df, vars = summary_vars)
{
    summarize_at(df, vars, 
                 list(obs = obs, mean = mean, sd = sd), na.rm = TRUE) %>%
    pivot_longer(cols = everything(), 
                 names_to = c("set", ".value"), 
                 names_pattern = "(.+)_([a-z]+)")
}

# generate separate tables for primed poor and primed rich
dat_rich <- dat_study1 %>%
    filter(priming == "primed rich")

dat_poor <- dat_study1 %>%
    filter(priming == "primed poor")

summary_rich <- make_summary_table(dat_rich)
summary_poor <- make_summary_table(dat_poor)
summary_out <- left_join(summary_rich, summary_poor, by = "set", 
                         suffix = c("", ".")) %>%
    mutate_at(vars(-"set"), ~(round(., digits = 1))) %>%
    rename(variable = set)
```

## Wilcox-Rank-Sum tests for Table 1 

```{r summary tests survey 1}
U_test <- function(var, df1 = dat_rich, df2 = dat_poor)
{
    wilcox.test(x = df1[[var]], 
                y = df2[[var]], 
                paired = FALSE)
}

stats <- tibble(variable = summary_vars, 
             results = map(variable, U_test), 
             p_value = map_dbl(results, pluck, "p.value"))

p_cutoffs <- c(0.1, 0.05, 0.01)
```

## Table 1

```{r, results = "asis"}
summary_out %>%
    mutate(mean = paste(pander::add.significance.stars(stats$p_value, 
                                                        cutoffs = p_cutoffs), mean)) %>% 
    gt() %>%
    tab_spanner(label = "primed rich", 
                columns = c("obs", "mean", "sd")) %>%
    tab_spanner(label = "primed poor", 
                columns = c("obs.", "mean.", "sd.")) %>%
    as_raw_html()
```

Stars (`*`, `* *`, `* * *`) indicate signifance at the `r p_cutoffs` levels, respectively.

## Figure 2

```{r}
#| fig.cap = "Histogram of Individual Payments"
    
ggplot(dat_study1) + 
    aes(x = payment, y = ..ncount.. / sum(..ncount..)) + 
    geom_histogram(bins = 11, color = "black") + 
    geom_hline(yintercept = 1/11, linetype = "dashed") + 
    scale_y_continuous(labels = percent_format()) + 
    theme_bw()
```

## Figure A1.1

To create figure 1, first labels for income groups have to be assigned, then new data for plotting is created and then the data is plotted.

```{r}
# Create variable to differentiate by treatment group
df_study1$treatment<-"1. Treatment 1"
df_study1$treatment[df_study1$rich==1]<-"2. Treatment 2"

df_study1$income_lab<-0

# Create labeled variable in same data
df_study1$income_lab[is.na(df_study1$income)==TRUE]<-16
df_study1$income_lab[df_study1$income<=0.08]<-1
df_study1$income_lab[df_study1$income>0.08&df_study1$income<=0.28]<-2
df_study1$income_lab[df_study1$income>0.28&df_study1$income<=0.800]<-3
df_study1$income_lab[df_study1$income>0.8&df_study1$income<=1.3]<-4
df_study1$income_lab[df_study1$income==1.75]<-5
df_study1$income_lab[df_study1$income==2.25]<-6
df_study1$income_lab[df_study1$income==2.75]<-7
df_study1$income_lab[df_study1$income==3.25]<-8
df_study1$income_lab[df_study1$income==3.75]<-9
df_study1$income_lab[df_study1$income==4.25]<-10
df_study1$income_lab[df_study1$income==4.75]<-11
df_study1$income_lab[df_study1$income==5.25]<-12
df_study1$income_lab[df_study1$income==5.75]<-13
df_study1$income_lab[df_study1$income==6.75]<-14
df_study1$income_lab[df_study1$income==8.75]<-15

incomelabs<-c("less than 150 Euro",
              "150 to less than 400 Euro",
              "400 to less than 1000 Euro",
              "1000 to less than 1500 Euro",
              "1500 to less than 2000 Euro",
              "2000 to less than 2500 Euro",
              "2500 to less than 3000 Euro",
              "3000 to less than 3500 Euro",
              "3500 to less than 4000 Euro",
              "4000 to less than 4500 Euro",
              "4500 to less than 5000 Euro",
              "5000 to less than 5500 Euro",
              "5500 to less than 6000 Euro",
              "5000 to less than 7500 Euro",
              "7500 Euro and more",
              "No Information")

df_study1$income_lab<- as.numeric(df_study1$income_lab)
df_study1$income_lab<- as.factor(df_study1$income_lab)
levels(df_study1$income_lab)<-incomelabs

# create plot data
plot_data1 <- df_study1[is.na(df_study1$treatment)==F,] %>% 
  count(treatment, income_lab) %>% 
  group_by(income_lab) %>% 
  mutate(percent = n/sum(n))

# position of count
plot_data1$pos[plot_data1$treatment=="1. Treatment 1"]<-0.9
plot_data1$pos[plot_data1$treatment=="2. Treatment 2"]<-0.1


# create figure
d1<-ggplot(plot_data1, aes(income_lab,percent))

d1+geom_bar(stat="identity",aes(fill=treatment))+
  scale_fill_manual(name="Treatment Group", labels=c("Primed-Poor", "Primed-Rich"),
                    values=c("1. Treatment 1"="grey38", "2. Treatment 2"="grey55"))+
  geom_text(data=plot_data1, aes(y=pos,label=n))+
  coord_flip()+
  ylab("Percent") + xlab("Income Group")

```

