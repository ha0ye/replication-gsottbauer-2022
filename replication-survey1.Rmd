---
title: "Supplementary-Survey1"
output: github_document
---

# Setup

First, load up the necessary packages. We are operating in interactive mode, so `{{tidyverse}}` can be used and is inclusive of `{{ggplot2}}`, `{{scales}}`, and `{{dplyr}}`.

```{r load packages}
library(readstata13)
library(psych)
library(tidyverse)
library(gt)
library(pander)
```

We don't need to set paths, and assume folks will follow the practice of using an RStudio project with the project folder as the main parent folder. All paths are thus local to that.

```{r set data paths}
datafile_survey_1 <- here::here("data", "MasterFile_Survey1.dta")
```

# Survey 1 (German Internet Panel)

## Read in data

```{r load data}
# load data - labels will be lost
df_study1 <- read.dta13(file = datafile_survey_1, 
                        convert.factors = TRUE, 
                        nonint.factors = TRUE)
```

## Recoding

```{r}
dat_study1 <- df_study1 %>%
    rename(priming = rich) %>%
    mutate(priming = case_match(priming, 
                                0 ~ "primed poor", 
                                1 ~ "primed rich"), 
           income = income * 1000, 
           male = male * 100, 
           married = married * 100, 
           student = student * 100, 
           east = east * 100)
```

## Generate Table 1 (sample summary statistics - survey 1)
```{r, results = "asis"}
summary_vars <- c("income", "male", "age", "edu", "married", 
                  "student", "religiousness", "east", "leftright")

# define function to count number of not NA values
obs <- function(x, na.rm) {sum(is.finite(x))}

# define function to create summary table
make_summary_table <- function(df, vars = summary_vars)
{
    summarize_at(df, vars, 
                 list(obs = obs, mean = mean, sd = sd), na.rm = TRUE) %>%
    pivot_longer(cols = everything(), 
                 names_to = c("set", ".value"), 
                 names_pattern = "(.+)_([a-z]+)")
}

# generate separate tables for primed poor and primed rich
dat_rich <- dat_study1 %>%
    filter(priming == "primed rich")

dat_poor <- dat_study1 %>%
    filter(priming == "primed poor")

summary_rich <- make_summary_table(dat_rich)
summary_poor <- make_summary_table(dat_poor)
summary_out <- left_join(summary_rich, summary_poor, by = "set", 
                         suffix = c("", ".")) %>%
    mutate_at(vars(-"set"), ~(round(., digits = 1))) %>%
    rename(variable = set)
```

## Wilcox-Rank-Sum tests for Table 1 

```{r summary tests survey 1}
U_test <- function(var, df1 = dat_rich, df2 = dat_poor)
{
    wilcox.test(x = df1[[var]], 
                y = df2[[var]], 
                paired = FALSE)
}

stats <- tibble(variable = summary_vars, 
             results = map(variable, U_test), 
             p_value = map_dbl(results, pluck, "p.value"))

p_cutoffs <- c(0.1, 0.05, 0.01)
```

## Display Table 1

```{r, results = "asis"}
summary_out %>%
    mutate(mean = paste(pander::add.significance.stars(stats$p_value, 
                                                        cutoffs = p_cutoffs), mean)) %>% 
    gt() %>%
    tab_spanner(label = "primed rich", 
                columns = c("obs", "mean", "sd")) %>%
    tab_spanner(label = "primed poor", 
                columns = c("obs.", "mean.", "sd.")) %>%
    as_raw_html()
```

Stars (`*`, `* *`, `* * *`) indicate signifance at the `r p_cutoffs` levels, respectively.
